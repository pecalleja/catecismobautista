{% extends "base.html" %}

{% block meta_description %}El Catecismo Bautista con la Exposición Bíblica de Beddome - {{ total_questions }} preguntas y respuestas para la instrucción en la fe cristiana.{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block og_url %}https://catecismobautista.org/{% endblock %}
{% block og_type %}website{% endblock %}
{% block canonical_url %}https://catecismobautista.org/{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "{{ title }}",
  "description": "{{ description }}",
  "url": "https://catecismobautista.org/",
  "inLanguage": "es",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://catecismobautista.org/buscar.html?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ title }}</h1>
    <p class="subtitle">{{ description }}</p>
    <p class="stats">{{ total_questions }} preguntas con exposición bíblica</p>
</div>

<section class="source-info">
    <div class="source-content">
        <div class="source-image">
            <a href="https://drive.google.com/file/d/1VByg-T7Q0gUY4p65OsWt7GShFR67az7O/view?usp=drive_link" target="_blank" rel="noopener noreferrer">
                <img src="/images/25-Exposicion-Catecismo_Cover-01-min-1325x2048-1.webp" alt="Portada del libro Una Exposición Bíblica del Catecismo Bautista" loading="lazy">
            </a>
        </div>
        <div class="source-text">
            <p>Este sitio web está construido a partir del libro "Una Exposición Bíblica del Catecismo Bautista a modo de Preguntas y Respuestas" publicado por <strong>© <a href="https://legadobautistaconfesional.com/" target="_blank" rel="noopener noreferrer">Editorial Legado Bautista Confesional</a></strong> (Santo Domingo – Ecuador, 2021).</p>
            <a href="https://drive.google.com/file/d/1VByg-T7Q0gUY4p65OsWt7GShFR67az7O/view?usp=drive_link" class="download-btn" target="_blank" rel="noopener noreferrer">
                Descarga Gratis PDF
            </a>
        </div>
    </div>
</section>

<section class="toc-section">
    <div class="toc-header">
        <h2>Tabla de Contenido</h2>
        <div class="toc-search">
            <input type="text" id="toc-filter" placeholder="Filtrar preguntas..." aria-label="Filtrar preguntas">
        </div>
    </div>

    <ol class="question-list">
        {% for q in questions %}
        <li class="question-item" data-number="{{ q.number }}">
            <a href="/pregunta/{{ q.number }}.html" class="question-link">
                <span class="question-number">{{ q.number }}</span>
                <span class="question-text">
                    <span class="q-title">{{ q.question }}</span>
                    <span class="q-answer">{{ q.full_answer }}</span>
                </span>
            </a>
        </li>
        {% endfor %}
    </ol>
</section>

{% endblock %}

{% block scripts %}
<script src="/js/unified-search.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var filter = document.getElementById('toc-filter');
    var items = document.querySelectorAll('.question-item');

    // Store original text content for restoration
    var originalContent = [];
    items.forEach(function(item) {
        var titleEl = item.querySelector('.q-title');
        var answerEl = item.querySelector('.q-answer');
        originalContent.push({
            title: titleEl ? titleEl.textContent : '',
            answer: answerEl ? answerEl.textContent : ''
        });
    });

    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() { func.apply(context, args); }, wait);
        };
    }

    var filterItems = debounce(function() {
        var query = filter.value.trim();

        items.forEach(function(item, index) {
            var titleEl = item.querySelector('.q-title');
            var answerEl = item.querySelector('.q-answer');
            var original = originalContent[index];

            if (query.length < 2) {
                item.style.display = '';
                // Restore original text (no highlighting)
                if (titleEl) titleEl.innerHTML = UnifiedSearch.escapeHtml(original.title);
                if (answerEl) answerEl.innerHTML = UnifiedSearch.escapeHtml(original.answer);
                return;
            }

            var matchesTitle = UnifiedSearch.textContains(original.title, query);
            var matchesAnswer = UnifiedSearch.textContains(original.answer, query);

            if (matchesTitle || matchesAnswer) {
                item.style.display = '';
                // Apply highlighting
                if (titleEl) titleEl.innerHTML = UnifiedSearch.highlightText(original.title, query);
                if (answerEl) answerEl.innerHTML = UnifiedSearch.highlightText(original.answer, query);
            } else {
                item.style.display = 'none';
            }
        });
    }, 150);

    filter.addEventListener('input', filterItems);
});
</script>
{% endblock %}
